<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mobile Money Transaction</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-[#18102f] text-white font-sans min-h-screen flex flex-col">


<!-- JavaScript Section at the bottom -->
<script>
  // Correct ternary operator
  const API_BASE_URL = window.location.hostname.includes("localhost")
    ? "http://localhost:8000"
    : "https://fraud-detection-api-xioa.onrender.com";

  // Update date/time display
  setInterval(() => {
    const now = new Date().toLocaleString();
    const timeDisplay = document.getElementById("currentDateTime");
    if (timeDisplay) timeDisplay.textContent = now;
  }, 1000);

  function addInputSearchListeners(inputId, onSearch) {
    const input = document.getElementById(inputId);
    if (!input) return;

    input.addEventListener("blur", () => {
      if (input.value.trim()) onSearch(input.value.trim());
    });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        if (input.value.trim()) {
          onSearch(input.value.trim());
          if (inputId === "beneficiaryphoneno") {
            const initiatorInput = document.getElementById("initiatorphoneno");
            if (initiatorInput) initiatorInput.focus();
          }
        }
      }
    });
  }

  async function fetchBeneficiaryName(phoneNumber) {
    const nameField = document.getElementById("beneficiaryname");
    nameField.value = "Searching...";
    nameField.readOnly = true;

    try {
      const res = await fetch(`${API_BASE_URL}/validate-beneficiary/${phoneNumber}`);
      const data = await res.json();

      if (data.success) {
        nameField.value = data.full_name;
      } else {
        nameField.value = "";
        nameField.placeholder = "Beneficiary not found";
        nameField.readOnly = false;
        alert("❌ Beneficiary account not found.");
      }
    } catch (err) {
      console.error("Error fetching beneficiary:", err);
      nameField.value = "";
      alert("⚠️ Server error while fetching beneficiary.");
    }
  }

  async function fetchInitiatorInfo(phoneNumber) {
    const initiatorNumberDiv = document.getElementById("initiatorNumber");
    const initiatorNameDiv = document.getElementById("initiatorName");
    const balanceDisplay = document.getElementById("balanceAmount");

    try {
      const res = await fetch(`${API_BASE_URL}/validate_initiator/${phoneNumber}`);
      const data = await res.json();

      if (data.success) {
        const balance = parseFloat(data.balance).toFixed(2);
        initiatorNumberDiv.textContent = phoneNumber;
        initiatorNameDiv.textContent = data.full_name || "Name not available";
        balanceDisplay.innerText = `Balance: GHS ${balance}`;

        document.getElementById("oldbalanceOrg").value = balance;
        document.getElementById("newbalanceOrig").value = balance;
      } else {
        initiatorNumberDiv.textContent = "Not Found";
        initiatorNameDiv.textContent = "Not Found";
        balanceDisplay.innerText = "Balance: GHS 0.00";
        alert("Initiator not found.");
      }
    } catch (err) {
      console.error("Error fetching initiator:", err);
      initiatorNumberDiv.textContent = "Error";
      initiatorNameDiv.textContent = "Error";
      balanceDisplay.innerText = "Balance: GHS 0.00";
      alert("Server error while fetching initiator.");
    }
  }

  function resetFormState(form) {
    form.reset();
    document.getElementById("initiatorNumber").textContent = "";
    document.getElementById("initiatorName").textContent = "";
    document.getElementById("balanceAmount").innerText = "Balance: GHS 0.00";
    document.getElementById("beneficiaryname").value = "";
    document.getElementById("oldbalanceOrg").value = "";
    document.getElementById("newbalanceOrig").value = "";
    document.getElementById("newbalanceDest").value = "";
  }

  async function submitTransaction(event) {
    event.preventDefault();

    const form = event.target;
    if (form.dataset.submitting === "true") return;
    form.dataset.submitting = "true";

    const amount = parseFloat(form.amount.value);
    const oldbalanceOrg = parseFloat(document.getElementById("oldbalanceOrg").value || "0");
    const newbalanceOrig = oldbalanceOrg - amount;
    const oldbalanceDest = parseFloat(document.getElementById("newbalanceDest").value || "0");
    const newbalanceDest = oldbalanceDest + amount;

    document.getElementById("newbalanceOrig").value = newbalanceOrig;
    document.getElementById("newbalanceDest").value = newbalanceDest;

    const transactionData = {
      step: parseInt(document.getElementById("step").value),
      trxdate: new Date().toISOString(),
      type: form.type.value.toUpperCase(),
      amount,
      nameOrig: form.initiatorphone.value,
      oldbalanceOrg,
      newbalanceOrig,
      nameDest: form.nameDest.value,
      beneficiaryname: form.beneficiaryname.value,
      oldbalanceDest,
      newbalanceDest,
      mobilenetwork: form.mobilenetwork.value,
      latitude: 5.6037,
      longitude: -0.1870
    };

    const submitBtn = form.querySelector("button[type='submit']");
    submitBtn.disabled = true;
    submitBtn.textContent = "Processing...";

    try {
      const res = await fetch(`${API_BASE_URL}/predict`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(transactionData)
      });

      const data = await res.json();

      if (res.ok && data.success) {
        const { status, is_fraud } = data;
        alert(`✅ Transaction was ${status}`);

        if (!is_fraud && status === "SUCCESSFUL") {
          document.getElementById("balanceAmount").innerText = `Balance: GHS ${newbalanceOrig.toFixed(2)}`;
          resetFormState(form);
        }
      } else {
        alert(data.detail || "❌ Prediction failed. Please check input.");
      }
    } catch (err) {
      console.error("Transaction error:", err);
      alert("⚠️ Server error occurred.");
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Submit Transaction";
      form.dataset.submitting = "false";
    }
  }

  // Ensure script executes only after DOM is loaded
  window.addEventListener("DOMContentLoaded", () => {
    addInputSearchListeners("beneficiaryphoneno", fetchBeneficiaryName);

    document.getElementById("beneficiaryphoneno").addEventListener("input", () => {
      const nameField = document.getElementById("beneficiaryname");
      nameField.value = "";
      nameField.placeholder = "Fetching name...";
      nameField.readOnly = true;
    });

    document.getElementById("initiatorphoneno").addEventListener("blur", (e) => {
      if (e.target.value.trim()) {
        fetchInitiatorInfo(e.target.value.trim());
      }
    });
  });
</script>

</body>
</html>
